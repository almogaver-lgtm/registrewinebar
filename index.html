<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>Registre de Visitants Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #10b981;
            --bg-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius-md: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 16px;
            color: var(--text-main);
        }

        .app-card {
            background: var(--surface);
            width: 100%;
            max-width: 480px;
            border-radius: 32px;
            padding: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            margin-top: 20px;
        }

        header { text-align: center; margin-bottom: 32px; }
        h1 { font-size: 24px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .section-label {
            font-size: 13px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 12px; display: block;
        }

        .grid-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .age-grid { grid-template-columns: repeat(4, 1fr); }

        .opt-btn {
            background: #f8fafc; border: 2px solid var(--border); padding: 14px 8px;
            border-radius: var(--radius-md); cursor: pointer; font-size: 14px; font-weight: 600;
            color: var(--text-muted); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }

        .opt-btn.active {
            background: white; border-color: var(--primary); color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary); transform: translateY(-2px);
        }

        .opt-btn span { font-size: 20px; }

        .form-group { margin-bottom: 20px; position: relative; }

        input {
            width: 100%; background: #f8fafc; border: 2px solid var(--border);
            padding: 16px; border-radius: var(--radius-md); font-size: 16px;
            font-family: inherit; color: var(--text-main); transition: all 0.2s;
        }

        input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* Estils llista pa√Øsos */
        .country-wrapper { position: relative; }
        .selected-flag-preview { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); pointer-events: none; }
        
        .suggestions-list {
            position: absolute; top: calc(100% + 8px); left: 0; right: 0;
            background: white; border-radius: var(--radius-md);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border);
            max-height: 250px; overflow-y: auto; z-index: 50; display: none;
        }

        .suggestion-item {
            padding: 12px 16px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 15px;
        }
        .suggestion-item:hover { background: #f8fafc; color: var(--primary); }

        #submitBtn {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: var(--radius-md); font-size: 16px;
            font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 10px;
        }

        #submitBtn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        .daily-counter {
            text-align: center; margin-top: 24px; padding-top: 20px;
            border-top: 1px solid #f1f5f9; font-size: 14px; font-weight: 600; color: var(--text-muted);
        }

        .modal {
            display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px); padding: 20px; z-index: 100; align-items: center; justify-content: center;
        }
        .modal-content { background: white; border-radius: 24px; padding: 32px; width: 100%; max-width: 400px; text-align: center; }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div class="app-card">
        <header>
            <h1><span>üìä</span> Registre de Visites</h1>
        </header>

        <section>
            <label class="section-label">Tipus de Visita</label>
            <div class="grid-options">
                <button class="opt-btn" id="btnHotel" onclick="selectType('HOTEL')"><span>üè®</span> Hotel</button>
                <button class="opt-btn" id="btnDefora" onclick="selectType('DE FORA')"><span>üö∂</span> De Fora</button>
            </div>

            <label class="section-label">Franja d'Edat</label>
            <div class="grid-options age-grid">
                <button class="opt-btn age-opt" onclick="selectAge('18-30')">18-30</button>
                <button class="opt-btn age-opt" onclick="selectAge('30-50')">30-50</button>
                <button class="opt-btn age-opt" onclick="selectAge('50-65')">50-65</button>
                <button class="opt-btn age-opt" onclick="selectAge('+65')">+65</button>
            </div>

            <form id="visitorForm" oninput="validateForm()">
                <div class="form-group">
                    <label class="section-label">Quants sou?</label>
                    <input type="number" id="numVisitors" placeholder="Ex: 2" min="1">
                </div>

                <div class="form-group country-wrapper">
                    <label class="section-label">Proced√®ncia</label>
                    <input type="text" id="countryInput" placeholder="Toca per seleccionar pa√≠s..." autocomplete="off">
                    <div id="flagPreview" class="selected-flag-preview"></div>
                    <div id="suggestions" class="suggestions-list"></div>
                </div>

                <button type="submit" id="submitBtn" disabled>Registrar Visita</button>
            </form>
        </section>

        <div class="daily-counter" id="counterUI">Avui: 0 visitants</div>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <div style="font-size: 60px;">‚ú®</div>
            <h2 style="margin: 10px 0;">Fet!</h2>
            <p>La visita s'ha guardat correctament.</p>
            <button class="modal-btn" onclick="closeModal('successModal')">Seg√ºent visita</button>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div style="font-size: 60px;">‚ö†Ô∏è</div>
            <h2 style="margin: 10px 0;">Confirmaci√≥</h2>
            <p id="confirmText"></p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-btn" style="flex:1; background: var(--accent);" onclick="executeSubmit()">√âs correcte</button>
                <button class="modal-btn" style="flex:1; background: #ef4444;" onclick="closeModal('confirmModal')">Corregir</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwSZ9-uBeSmYNtTPofLDTfdHmy_VeDzDob09TmyEcomJ88KS_yvuWEvFOeaf-Las7K/exec';
        
        // Llista ampliada de pa√Øsos
        const countries = [
            { name: "Catalunya", code: "es-ct" }, { name: "Espanya", code: "es" }, { name: "Andorra", code: "ad" },
            { name: "Fran√ßa", code: "fr" }, { name: "Portugal", code: "pt" }, { name: "It√†lia", code: "it" },
            { name: "Alemanya", code: "de" }, { name: "Regne Unit", code: "gb" }, { name: "Irlanda", code: "ie" },
            { name: "B√®lgica", code: "be" }, { name: "Pa√Øsos Baixos", code: "nl" }, { name: "Su√Øssa", code: "ch" },
            { name: "√Äustria", code: "at" }, { name: "Pol√≤nia", code: "pl" }, { name: "Rep√∫blica Txeca", code: "cz" },
            { name: "Hongria", code: "hu" }, { name: "Su√®cia", code: "se" }, { name: "Noruega", code: "no" },
            { name: "Dinamarca", code: "dk" }, { name: "Finl√†ndia", code: "fi" }, { name: "Gr√®cia", code: "gr" },
            { name: "Turquia", code: "tr" }, { name: "Estats Units", code: "us" }, { name: "Canad√†", code: "ca" },
            { name: "M√®xic", code: "mx" }, { name: "Col√≤mbia", code: "co" }, { name: "Argentina", code: "ar" },
            { name: "Brasil", code: "br" }, { name: "Xile", code: "cl" }, { name: "Per√∫", code: "pe" },
            { name: "Uruguai", code: "uy" }, { name: "R√∫ssia", code: "ru" }, { name: "Xina", code: "cn" },
            { name: "Jap√≥", code: "jp" }, { name: "Corea del Sud", code: "kr" }, { name: "√çndia", code: "in" },
            { name: "Israel", code: "il" }, { name: "Austr√†lia", code: "au" }, { name: "Nova Zelanda", code: "nz" },
            { name: "Marroc", code: "ma" }, { name: "Egipte", code: "eg" }, { name: "Sud-√†frica", code: "za" }
        ].sort((a, b) => a.name.localeCompare(b.name));

        let state = { type: null, age: null, country: null, num: null };

        function selectType(t) {
            state.type = t;
            document.getElementById('btnHotel').classList.toggle('active', t === 'HOTEL');
            document.getElementById('btnDefora').classList.toggle('active', t === 'DE FORA');
            validateForm();
        }

        function selectAge(a) {
            state.age = a;
            document.querySelectorAll('.age-opt').forEach(b => b.classList.toggle('active', b.innerText === a));
            validateForm();
        }

        const countryInput = document.getElementById('countryInput');
        const suggestionsUI = document.getElementById('suggestions');

        // Funci√≥ per mostrar suggeriments
        function showCountries(filter = "") {
            suggestionsUI.innerHTML = '';
            const matches = countries.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()));
            
            if (matches.length > 0) {
                matches.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const flag = c.code === 'es-ct' ? 'üìç' : `<img src="https://flagcdn.com/w20/${c.code}.png" width="20">`;
                    div.innerHTML = `${flag} <span>${c.name}</span>`;
                    div.onclick = () => {
                        countryInput.value = c.name;
                        state.country = c.name;
                        document.getElementById('flagPreview').innerHTML = flag;
                        suggestionsUI.style.display = 'none';
                        validateForm();
                    };
                    suggestionsUI.appendChild(div);
                });
                suggestionsUI.style.display = 'block';
            } else {
                suggestionsUI.style.display = 'none';
            }
        }

        countryInput.addEventListener('focus', () => showCountries(countryInput.value));
        countryInput.addEventListener('input', (e) => {
            state.country = null;
            showCountries(e.target.value);
            validateForm();
        });

        function validateForm() {
            state.num = document.getElementById('numVisitors').value;
            const isValid = state.type && state.age && state.country && state.num > 0;
            document.getElementById('submitBtn').disabled = !isValid;
        }

        const form = document.getElementById('visitorForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (state.num > 10) {
                document.getElementById('confirmText').innerText = `Heu posat ${state.num} visitants. Tot correcte?`;
                document.getElementById('confirmModal').style.display = 'flex';
            } else {
                executeSubmit();
            }
        });

        async function executeSubmit() {
            closeModal('confirmModal');
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "Guardant...";

            const now = new Date();
            const data = {
                date: now.toLocaleDateString('ca-ES'),
                time: now.toLocaleTimeString('ca-ES', { hour: '2-digit', minute: '2-digit' }),
                numVisitors: state.num,
                country: state.country,
                type: state.type,
                age: state.age
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                if (navigator.vibrate) navigator.vibrate([50, 30, 50]); 
                updateLocalCounter(state.num);
                document.getElementById('successModal').style.display = 'flex';
                resetForm();
            } catch (e) {
                alert("Error de connexi√≥");
                btn.disabled = false;
            } finally {
                btn.innerText = "Registrar Visita";
            }
        }

        function updateLocalCounter(n) {
            const today = new Date().toLocaleDateString('ca-ES');
            let stats = JSON.parse(localStorage.getItem('stats')) || { date: today, count: 0 };
            if (stats.date !== today) stats = { date: today, count: 0 };
            stats.count += parseInt(n);
            localStorage.setItem('stats', JSON.stringify(stats));
            document.getElementById('counterUI').innerText = `Avui: ${stats.count} visitants`;
        }

        function resetForm() {
            form.reset();
            state = { type: null, age: null, country: null, num: null };
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('flagPreview').innerHTML = '';
            validateForm();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        updateLocalCounter(0);

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.country-wrapper')) suggestionsUI.style.display = 'none';
        });
    </script>
</body>
</html>
